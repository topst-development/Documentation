# 1. Introduction
This page provides guidance based on the Ubuntu OS installed on the host PC (regardless of whether it is WSL or a local Ubuntu installation). The image to be uploaded to the D3-G is built using the Yocto Project, and therefore the process must be carried out in the Ubuntu environment.

<br/><br/>

# 2. TOSPT D3-G Linux SDK

## 2.1 SDK Build Prepration

TOPST D3 Linux SDK is based on Yocto Project 3.1 Dunfell. Therefore, the Yocto Project environment must be set on the host PC to use TOPST D3 Linux SDK. To download SDK, source-mirror, and tools, you must install utilities. To build the image smoothly, the user's PC must have **at least 60 GB of available storage** and **a minimum of 16 GB of RAM**.

<br/>

## 2.2 Yocto Project  

The Yocto Project is an open source project focuses on embedded Linux development.  
It uses a combination of Open Embedded project, which is Poky, and ***bitbake*** as the build system to make Linux images.  
By using Yocto Project, you can simultaneously build the bootloader, kernel, and rootfs.  

<br/>

## 2.3 Task Process of Yocto Project

Figure 2.1 shows the task process of Yocto Project. You can download source from upstream based on metadata and build it. After the build is completed, package, image, and SDK are provided as results.

<p align="center">
    <img src="../../../Assets/TOPST D3-G/Software/2.1 yocto project task process.png", width="700">
</p>
<p align="center"><strong>Figure 2.1 Yocto Project Task Process</strong></p>

<br/>

## 2.4 Composition of TOPST D3-G SDK
The following are the components of the Yocto Project we have configured.
Figure 2.2 shows composition of TOSPT D3-G SDK.

<p align="center">
    <img src="../../../Assets/TOPST D3-G/Software/2.2 composition of TOPST D3-G SDK.png">
</p>
<p align="center"><strong>Figure 2.2 Composition of TOPST D3-G</strong></p>

<br/>

# 2.5. Ready to build
The following sections provide instructions on how to configure the Yocto Project to build the D3-G image.

**업데이트 예정: Gitlab->Github으로 주소이전 관계로 ssh 관련 설정 제거예정입니다.(2.5.1, 2.5.2)**

<br/>

### 2.5.1 Create and regist SSH Key

```
$ ssh-keygen
$ cat ~/.ssh/id_rsa.pub
ssh-rsa AAAA ... MYFI4PP8kik= ben@topst // may vary depending on the user
```
<br/>

After you create SSH Key, register your SSH Key in [GITLAB](https://gitlab.com/-/user_settings/ssh_keys). 

<p algin="center"><img src="https://github.com/topst-development/Documentation/assets/161264431/1b888871-d8a7-4adb-9d33-d6c839168e00"></p>
<p align="center"><strong>Figure 2.2 Register SSH Key -> 삭제예정</strong></p>

<br/>

### 2.5.2 Create SSH config 
```
$ vi ~/.ssh/config

Host gitlab.com
    User git
    IdentityFile ~/.ssh/id_rsa
```

<br/>


### 2.5.3 Get TOPST-D3 with Git

```
$ mkdir topst
$ cd topst

$ repo init -u https://github.com/topst-development/manifest -m topst-d3-pre-v0.1.xml
Downloading Repo source from https://gerrit.googlesource.com/git-repo

... A new version of repo (2.45) is available.
... New version is available at: /home/ben/topst/.repo/repo/repo
... The launcher is run from: /usr/bin/repo
!!! The launcher is not writable.  Please talk to your sysadmin or distro
!!! to get an update installed.


Your identity is: Seonguk Nam <topstdeveloper@gmail.com>
If you want to change this, please re-run 'repo init' with --config-name

repo has been initialized in /home/ben/topst

$ repo sync

... A new version of repo (2.45) is available.
... New version is available at: /home/ben/topst/.repo/repo/repo
... The launcher is run from: /usr/bin/repo
!!! The launcher is not writable.  Please talk to your sysadmin or distro
!!! to get an update installed.

Fetching: 100% (9/9), done in 13.638s
Checking out: 100% (9/9), done in 0.510s
repo sync has finished successfully.
```

<br/><br/>

## 2.6 Execute easy-setup Script  
The `easy-setup.sh` is a shell script designed to build the D3-G image by selecting the appropriate core configuration.

<br/>

### 2.6.1 Build Single Core(Maincore)  

When you run 'easy-setup.sh', you can see the screen below.  
```
$ ./easy-setup.sh
```
<p align="center"><img src="../../../Assets/TOPST D3-G/Software/2.3 end user license agreement.png"></p>
<p align="center"><strong>Figure 2.3 End User License Agreement</strong></p>  

You must read this notice until scroll down to bottom.  
After you read this notice, go to "Proceed to confirm" with right arrow key.

<p align="center"><img src="../../../Assets/TOPST D3-G/Software/proceed to confirm.png"></p>
<p align="center"><strong>Figure 2.4 Go To 'Proceed to confirm'</strong></p>

Then you can see the screen below.
<p align="center"><img src="../../../Assets/TOPST D3-G/Software/accept.png"></p>
<p align="center"><strong>Figure 2.5 Accept Screen</strong></p>

If you select Accept, you can build following command.
```
[+] Please execute the following command to initiate the build process

	source yocto/poky/oe-init-build-env build-main
	bitbake telechips-topst-image

[!] Will you use subcore? (yes/no) no
```
```
$ source yocto/poky/oe-init-build-env build-main

### Shell environment set up for builds. ###

You can now run 'bitbake <target>'

Common targets are:
    core-image-minimal
    core-image-full-cmdline
    core-image-sato
    core-image-weston
    meta-toolchain
    meta-ide-support

You can also run generated qemu images with a command like 'runqemu qemux86'

Other commonly useful commands are:
 - 'devtool' and 'recipetool' handle common recipe tasks
 - 'bitbake-layers' handles common layer tasks
 - 'oe-pkgdata-util' handles common target package tasks
```
Now, you can build D3-G image following command. 
```
$ bitbake telechips-topst-image
```
<br/>

### 2.6.2 Build Dual Core(Maincore and Subcore) => 현재 지원되는지 확인
```
```

<br/>

### 2.7 Make FWDN Image

This option creates a binary into one image for TOPST D3 platform image.

The **output.fwdn.zip** including **'output.fai' build image** and **fwdn tools** is created in the following path:

- {TOPST_PATH}/

```
$ ./stitch-fai.sh -f

Filesystem too small for a journal
[mktcimg] v1.2.1 - Nov 15 2021 19:33:18
location : bl3_ca72_a 
location : 4096 sector(2097152 byte)
location : build-main/tmp/deploy/images/tcc8050-main/ca72_bl3.rom 
location : boot 
location : 122880 sector(62914560 byte)
location : build-main/tmp/deploy/images/tcc8050-main/tc-boot-tcc8050-main.img 
location : system 
location : 11534336 sector(5905580032 byte)
location : build-main/tmp/deploy/images/tcc8050-main/topst-tcc8050-main.ext4 
location : dtb 
location : 400 sector(204800 byte)
location : build-main/tmp/deploy/images/tcc8050-main/tcc8050-linux-topst-d3-pre-v0.1.dtb 
location : env 
location : 2048 sector(1048576 byte)
location : misc 
location : 2048 sector(1048576 byte)
location : splash 
location : 81920 sector(41943040 byte)
location : home 
location : 3516416 sector(1800404992 byte)
location : /home/ben/topst/.stitch_XXRNlst/home-directory.ext4 
location : data 
location : 2048 sector(1048576 byte)
location : /home/ben/topst/.stitch_XXRNlst/user-data.ext4 
path : build-main/tmp/deploy/images/tcc8050-main/ca72_bl3.rom 
uuid : 372cbca7-25e2-480b-b8ec-2736ed1f02d0 , part-name : bl3_ca72_a 
uuid : b12c0ebc-2802-4d04-92ae-a52bbc3082e5 , part-name : boot 
uuid : bbd5770e-1f3d-4bc6-ac17-4abeecf14a1e , part-name : system 
uuid : 541d9405-8d40-43cf-9255-74fc5c0fbef7 , part-name : dtb 
uuid : d71a2a08-9ffe-4690-8b27-c6c371f5b4a8 , part-name : env 
uuid : e9e9b9f3-27b9-4822-9ab5-bb09554dfde2 , part-name : misc 
uuid : 49578c16-ea11-4f27-bc82-c1f9a60ce33b , part-name : splash 
uuid : 2cf93985-4ae4-4ea0-bc67-6c991ac8eb7d , part-name : home 
uuid : ccc4aaaa-92a1-4e02-b55d-215a0ad92d29 , part-name : data 
crc32 of header : f33d4c30 
crc32 of partition array : a65980dc 
idx : 0  bl3_ca72_a 
idx : 1  boot 
idx : 2  system 
idx : 3  dtb 
idx : 7  home 
idx : 8  data 
crc32 of header : f33d4c30 
crc32 of partition array : 61f17e08 
Complete to make fai file

===== arguments info =====

--storage_size : 7818182656
--parttype : gpt
--area_name : "SD Data"
--outfile : /home/ben/topst/.stitch_XXRNlst/output.fai
--gptfile : /home/ben/topst/.stitch_XXRNlst/output.gpt
--fplist : /home/ben/topst/.stitch_XXRNlst/partition.single.list
--sector_size : 512
--sparse_fill : 0

===========================

[+] Packaging FWDN binaries
  adding: output.fai (deflated 97%)
  adding: VtcUsbPort.dll (deflated 64%)
  adding: boot-firmware/ (stored 0%)
  adding: fwdn (deflated 63%)
  adding: fwdn.bat (deflated 40%)
  adding: fwdn.exe (deflated 57%)
  adding: fwdn.sh (deflated 44%)
  adding: output.gpt (deflated 98%)
  adding: output.gpt.back (deflated 97%)
  adding: output.gpt.prim (deflated 97%)
  adding: boot-firmware/bconf.dual.bin (deflated 94%)
  adding: boot-firmware/bconf.single.bin (deflated 93%)
  adding: boot-firmware/boot.dual.json (deflated 86%)
  adding: boot-firmware/boot.single.json (deflated 86%)
  adding: boot-firmware/ca53_bl1.rom (deflated 51%)
  adding: boot-firmware/ca53_bl2.rom (deflated 50%)
  adding: boot-firmware/ca72_bl1.rom (deflated 51%)
  adding: boot-firmware/ca72_bl2.rom (deflated 49%)
  adding: boot-firmware/dram_params.bin (deflated 78%)
  adding: boot-firmware/fwdn.json (deflated 41%)
  adding: boot-firmware/fwdn.rom (deflated 46%)
  adding: boot-firmware/hsm.bin (deflated 51%)
  adding: boot-firmware/hsm.cs.bin (deflated 13%)
  adding: boot-firmware/mcert.bin (deflated 96%)
  adding: boot-firmware/optee.rom (deflated 92%)
  adding: boot-firmware/scfw.rom (deflated 53%)

```

Finally, you can check **'output.zip'**.
